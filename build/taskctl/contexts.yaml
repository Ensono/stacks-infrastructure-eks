#TODO: Remove AmidoBuild scripts mounts. Update independent runner image instead.
contexts:
  powershell:
    executable:
      bin: docker
      args:
        - run
        - --rm
        - -v
        - ${PWD}:/app
        - -v
        - /var/run/docker.sock:/var/run/docker.sock
        - -v
        - ${PWD}:/app
        - -v
        - /var/run/docker.sock:/var/run/docker.sock
        - -v
        - ${PWD}/AmidoBuild.psm1:/modules/AmidoBuild/AmidoBuild.psm1
        - -v
        - ${PWD}/AmidoBuild.psd1:/modules/AmidoBuild/AmidoBuild.psd1
        - -e
        - PSModulePath=/modules
        - -w
        - /app
        - --env-file
        - envfile
        - amidostacks/runner-pwsh:0.4.27-unstable
        - pwsh
        - -NoProfile
        - -NonInteractive
        - -Command
    quote: "'"
    before: env | grep -v PATH | grep -v SOURCEVERSIONMESSAGE | grep -v HOME > envfile

  powershell-dotnet:
    executable:
      bin: docker
      args:
        - run
        - --rm
        - -v
        - ${PWD}:/app
        - -v
        - /var/run/docker.sock:/var/run/docker.sock
        - -e
        - PSModulePath=/modules
        - -w
        - /app
        - --env-file
        - envfile
        - amidostacks/runner-pwsh-dotnet:0.4.25-unstable
        - pwsh
        - -NoProfile
        - -NonInteractive
        - -Command
    quote: "'"
    env:
      DOTNET_ARGUMENTS: "-v q /p:CollectCoverage=true /p:CoverletOutputFormat=opencover"
    before: env | grep -v PATH | grep -v SOURCEVERSIONMESSAGE | grep -v HOME > envfile
